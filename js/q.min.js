/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
(function(n){if(typeof bootstrap=="function")bootstrap("promise",n);else if(typeof exports=="object")module.exports=n();else if(typeof define=="function")define(n);else if(typeof ses!="undefined")if(ses.ok())ses.makeQ=n;else return;else Q=n()})(function(){"use strict";function ei(n){return fi(n)==="[object StopIteration]"||n instanceof it}function vt(n,t){t.stack&&typeof n=="object"&&n!==null&&n.stack&&n.stack.indexOf(rt)===-1&&(n.stack=yt(n.stack)+"\n"+rt+"\n"+yt(t.stack))}function yt(n){for(var t,r=n.split("\n"),u=[],i=0;i<r.length;++i)t=r[i],si(t)||oi(t)||u.push(t);return u.join("\n")}function oi(n){return n.indexOf("(module.js:")!==-1||n.indexOf("(node.js:")!==-1}function si(n){var t=/at .+ \((.*):(\d+):\d+\)/.exec(n),r,i;return t?(r=t[1],i=t[2],r===ht&&i>=ii&&i<=ti):!1}function pt(){if(Error.captureStackTrace){var n,t,i=Error.prepareStackTrace;return Error.prepareStackTrace=function(i,r){n=r[1].getFileName();t=r[1].getLineNumber()},(new Error).stack,Error.prepareStackTrace=i,ht=n,t}}function wt(n,t,i){return function(){return typeof console!="undefined"&&typeof console.warn=="function"&&console.warn(t+" is deprecated, use "+i+" instead.",new Error("").stack),n.apply(n,arguments)}}function n(n){return o(n)}function i(){function l(n){t&&(s=o(n),v(t,function(n,t){u(function(){s.promiseDispatch.apply(s,t)})},void 0),t=void 0,c=void 0)}var t=[],c=[],s,h=tt(i.prototype),n=tt(f.prototype);return n.promiseDispatch=function(n,i,f){var e=r(arguments);t?(t.push(e),i==="when"&&f[1]&&c.push(f[1])):u(function(){s.promiseDispatch.apply(s,e)})},n.valueOf=function(){return t?n:s.valueOf()},Error.captureStackTrace&&(Error.captureStackTrace(n,i),n.stack=n.stack.substring(n.stack.indexOf("\n")+1)),y(n),h.promise=n,h.resolve=l,h.fulfill=function(n){l(et(n))},h.reject=function(n){l(e(n))},h.notify=function(n){t&&v(c,function(t,i){u(function(){i(n)})},void 0)},h}function hi(n){var t=i();return st(n,t.resolve,t.reject,t.notify).fail(t.reject),t.promise}function f(n,t,i,r){t===void 0&&(t=function(n){return e(new Error("Promise does not support operation: "+n))});var u=tt(f.prototype);return u.promiseDispatch=function(i,r,f){var o;try{o=n[r]?n[r].apply(u,f):t.call(u,r,f)}catch(s){o=e(s)}i&&i(o)},i&&(u.valueOf=i),r&&(u.exception=r),y(u),u}function c(n){return p(n)?n.valueOf():n}function p(n){return n&&typeof n.promiseDispatch=="function"}function ut(n){return n&&typeof n.then=="function"}function ci(n){return ft(n)||bt(n)}function ft(n){return!ut(c(n))}function bt(n){return n=c(n),p(n)&&"exception"in n}function li(){kt||typeof window=="undefined"||window.Touch||!window.console||console.log("Should be empty:",b);kt=!0}function e(n){var t=f({when:function(t){if(t){var i=ri(w,this);i!==-1&&(b.splice(i,1),w.splice(i,1))}return t?t(n):e(n)}},function(){return e(n)},function(){return this},n);return li(),w.push(t),b.push(n),t}function et(n){return f({when:function(){return n},get:function(t){return n[t]},set:function(t,i){return n[t]=i,n},"delete":function(t){return delete n[t],n},post:function(t,i){return n[t].apply(n,i)},apply:function(t){return n.apply(void 0,t)},keys:function(){return ui(n)}},void 0,function(){return n})}function o(n){return p(n)?n:(n=c(n),ut(n)?ai(n):et(n))}function ai(n){var t=i();return n.then(t.resolve,t.reject,t.notify),t.promise}function vi(n){return f({isDef:function(){}},function(t,i){return ot(n,t,i)},function(){return c(n)})}function t(t,r,f,s){function a(n){try{return typeof r=="function"?r(n):n}catch(t){return e(t)}}function v(n){if(typeof f=="function"){vt(n,l);try{return f(n)}catch(t){return e(t)}}return e(n)}function y(n){return typeof s=="function"?s(n):n}var h=i(),c=!1,l=o(t);return u(function(){l.promiseDispatch(function(n){c||(c=!0,h.resolve(a(n)))},"when",[function(n){c||(c=!0,h.resolve(v(n)))}])}),l.promiseDispatch(void 0,"when",[void 0,function(t){var i,r=!1;try{i=y(t)}catch(u){if(r=!0,n.onerror)n.onerror(u);else throw u;}r||h.notify(i)}]),h.promise}function dt(n,i,r){return t(n,function(n){return d(n).then(function(n){return i.apply(void 0,n)},r)},r)}function yi(n){return function(){function i(n,i){var s;try{s=u[n](i)}catch(o){return ei(o)?o.value:e(o)}return t(s,r,f)}var u=n.apply(this,arguments),r=i.bind(i,"send"),f=i.bind(i,"throw");return r()}}function pi(n){throw new it(n);}function wi(n){return function(){return dt([this,d(arguments)],function(t,i){return n.apply(t,i)})}}function ot(n,t,r){var f=i();return u(function(){o(n).promiseDispatch(f.resolve,t,r)}),f.promise}function s(n){return function(t){var i=r(arguments,1);return ot(t,n,i)}}function st(n){var t=r(arguments,1);return l(n,t)}function bi(n){var t=r(arguments,1);return function(){var i=t.concat(r(arguments));return l(n,i)}}function d(n){return t(n,function(n){var u=n.length,r;return u===0?o(n):(r=i(),v(n,function(i,f,e){ft(f)?(n[e]=c(f),--u==0&&r.resolve(n)):t(f,function(t){n[e]=t;--u==0&&r.resolve(n)}).fail(r.reject)},void 0),r.promise)})}function ki(n){return t(n,function(n){return t(d(at(n,function(n){return t(n,g,g)})),function(){return at(n,o)})})}function gt(n,i){return t(n,void 0,i)}function di(n,i){return t(n,void 0,void 0,i)}function gi(n,i){return t(n,function(n){return t(i(),function(){return n})},function(n){return t(i(),function(){return e(n)})})}function nr(i,r,f,e){var o=function(t){u(function(){if(vt(t,i),n.onerror)n.onerror(t);else throw t;})},s=r||f||e?t(i,r,f,e):i;typeof process=="object"&&process&&process.domain&&(o=process.domain.bind(o));gt(s,o)}function tr(n,r){var u=i(),f=setTimeout(function(){u.reject(new Error("Timed out after "+r+" ms"))},r);return t(n,function(n){clearTimeout(f);u.resolve(n)},function(n){clearTimeout(f);u.reject(n)}),u.promise}function ir(n,t){t===void 0&&(t=n,n=void 0);var r=i();return setTimeout(function(){r.resolve(n)},t),r.promise}function rr(n,t){var f=r(t),u=i();return f.push(u.makeNodeResolver()),l(n,f).fail(u.reject),u.promise}function ur(n){var u=r(arguments,1),t=i();return u.push(t.makeNodeResolver()),l(n,u).fail(t.reject),t.promise}function fr(n){var t=r(arguments,1);return function(){var f=t.concat(r(arguments)),u=i();return f.push(u.makeNodeResolver()),l(n,f).fail(u.reject),u.promise}}function er(n,t,u){var e=r(u),f=i();return e.push(f.makeNodeResolver()),k(n,t,e).fail(f.reject),f.promise}function ni(n,t){var f=r(arguments,2),u=i();return f.push(u.makeNodeResolver()),k(n,t,f).fail(u.reject),u.promise}function or(n,t){if(t)n.then(function(n){u(function(){t(null,n)})},function(n){u(function(){t(n)})});else return n}var ii=pt(),ht,g=function(){},y=Object.freeze||g,u,h,nt,it,rt,w,b,kt,k,l,ti;if(typeof cajaVM!="undefined"&&(y=cajaVM.def),typeof process!="undefined")u=process.nextTick;else if(typeof setImmediate=="function")u=setImmediate;else if(typeof MessageChannel!="undefined"){var ct=new MessageChannel,a={},lt=a;ct.port1.onmessage=function(){a=a.next;var n=a.task;delete a.task;n()};u=function(n){lt=lt.next={task:n};ct.port2.postMessage(0)}}else u=function(n){setTimeout(n,0)};Function.prototype.bind?(nt=Function.prototype.bind,h=nt.bind(nt.call)):h=function(n){return function(){return n.call.apply(n,arguments)}};var r=h(Array.prototype.slice),v=h(Array.prototype.reduce||function(n,t){var i=0,r=this.length;if(arguments.length===1)do{if(i in this){t=this[i++];break}if(++i>=r)throw new TypeError;}while(1);for(;i<r;i++)i in this&&(t=n(t,this[i],i));return t}),ri=h(Array.prototype.indexOf||function(n){for(var t=0;t<this.length;t++)if(this[t]===n)return t;return-1}),at=h(Array.prototype.map||function(n,t){var i=this,r=[];return v(i,function(u,f,e){r.push(n.call(t,f,e,i))},void 0),r}),tt=Object.create||function(n){function t(){}return t.prototype=n,new t},ui=Object.keys||function(n){var t=[];for(var i in n)t.push(i);return t},fi=Object.prototype.toString;return it=typeof ReturnValue!="undefined"?ReturnValue:function(n){this.value=n},rt="From previous event:",n.nextTick=u,n.defer=i,i.prototype.makeNodeResolver=function(){var n=this;return function(t,i){t?n.reject(t):arguments.length>2?n.resolve(r(arguments,1)):n.resolve(i)}},n.promise=hi,n.makePromise=f,f.prototype.then=function(n,i,r){return t(this,n,i,r)},f.prototype.thenResolve=function(n){return t(this,function(){return n})},v(["isResolved","isFulfilled","isRejected","dispatch","when","spread","get","put","set","del","delete","post","send","invoke","keys","fapply","fcall","fbind","all","allResolved","timeout","delay","catch","finally","fail","fin","progress","done","nfcall","nfapply","nfbind","ncall","napply","nbind","npost","nsend","ninvoke","nodeify"],function(t,i){f.prototype[i]=function(){return n[i].apply(n,[this].concat(r(arguments)))}},void 0),f.prototype.toSource=function(){return this.toString()},f.prototype.toString=function(){return"[object Promise]"},y(f.prototype),n.nearer=c,n.isPromise=p,n.isPromiseAlike=ut,n.isResolved=ci,n.isFulfilled=ft,n.isRejected=bt,w=[],b=[],n.reject=e,n.fulfill=et,n.resolve=o,n.master=vi,n.when=t,n.spread=dt,n.async=yi,n["return"]=pi,n.promised=wi,n.dispatch=ot,n.dispatcher=s,n.get=s("get"),n.put=n.set=s("set"),n["delete"]=n.del=s("delete"),k=n.post=s("post"),n.send=function(n,t){var i=r(arguments,2);return k(n,t,i)},n.invoke=wt(n.send,"invoke","send"),l=n.fapply=s("apply"),n["try"]=st,n.fcall=st,n.fbind=bi,n.keys=s("keys"),n.all=d,n.allResolved=ki,n["catch"]=n.fail=gt,n.progress=di,n["finally"]=n.fin=gi,n.done=nr,n.timeout=tr,n.delay=ir,n.nfapply=rr,n.nfcall=ur,n.nfbind=fr,n.npost=er,n.nsend=ni,n.ninvoke=wt(ni,"ninvoke","nsend"),n.nodeify=or,ti=pt(),n});